<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Poster Rotator</title>
</head>
<body>
  <div id="PosterRotatorConfigPage"
       data-role="page"
       class="page type-interior pluginConfigurationPage"
       data-require="emby-input,emby-button,emby-checkbox">

    <div data-role="content">
      <div class="content-primary">
        <form id="PosterRotatorConfigForm">

          <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="PoolSize">Pool Size (posters per movie)</label>
            <input id="PoolSize" type="number" min="1" is="emby-input" value="5" />
          </div>

          <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="MinHoursBetweenSwitches">Minimum hours between switches</label>
            <input id="MinHoursBetweenSwitches" type="number" min="1" is="emby-input" value="24" />
            <div class="fieldDescription">Default: 24. This cooldown is enforced per item.</div>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription">
            <label class="emby-checkbox-label">
              <input id="SequentialRotation" type="checkbox" is="emby-checkbox" />
              <span>Sequential rotation (unchecked = random)</span>
            </label>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription">
            <label class="emby-checkbox-label">
              <input id="SaveNextToMedia" type="checkbox" is="emby-checkbox" />
              <span>Save posters next to movie (./poster_pool)</span>
            </label>
          </div>

          <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="ExtraPosterPatterns">Extra Poster Patterns (comma-separated)</label>
            <input id="ExtraPosterPatterns" type="text" is="emby-input" placeholder="folder.jpg, alt-*.png" />
          </div>

          <div>
            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
              <span>Save</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="text/javascript">
      (function () {
        var pluginId = '7f6eea8b-0e9c-4cbd-9d2a-31f9a37ce2b7'; // MUST match Plugin.Id

        function byId(id) { return document.getElementById(id); }

        function load() {
          Dashboard.showLoadingMsg();
          ApiClient.getPluginConfiguration(pluginId)
            .then(function (cfg) {
              if (byId('PoolSize')) byId('PoolSize').value = (cfg.PoolSize ?? 5);
              if (byId('MinHoursBetweenSwitches')) byId('MinHoursBetweenSwitches').value = (cfg.MinHoursBetweenSwitches ?? 24);
              if (byId('SequentialRotation')) byId('SequentialRotation').checked = !!cfg.SequentialRotation;
              if (byId('SaveNextToMedia')) byId('SaveNextToMedia').checked = (cfg.SaveNextToMedia !== false);
              if (byId('ExtraPosterPatterns')) byId('ExtraPosterPatterns').value = (cfg.ExtraPosterPatterns || []).join(', ');
            })
            .catch(function (err) {
              console.error('PosterRotator load error:', err);
              alert('Failed to load configuration. See console for details.');
            })
            .finally(function () { Dashboard.hideLoadingMsg(); });
        }

        function save(e) {
          e && e.preventDefault();
          Dashboard.showLoadingMsg();

          ApiClient.getPluginConfiguration(pluginId)
            .then(function (cfg) {
              var n = parseInt((byId('PoolSize')?.value || '5'), 10);
              cfg.PoolSize = (isNaN(n) || n < 1) ? 5 : n;

              var h = parseInt((byId('MinHoursBetweenSwitches')?.value || '24'), 10);
              cfg.MinHoursBetweenSwitches = (isNaN(h) || h < 1) ? 24 : h;

              cfg.SequentialRotation = !!(byId('SequentialRotation') && byId('SequentialRotation').checked);
              cfg.SaveNextToMedia = !!(byId('SaveNextToMedia') && byId('SaveNextToMedia').checked);

              var extra = (byId('ExtraPosterPatterns')?.value || '');
              cfg.ExtraPosterPatterns = extra.split(',').map(function (s) { return s.trim(); }).filter(Boolean);

              return ApiClient.updatePluginConfiguration(pluginId, cfg);
            })
            .then(function (result) { Dashboard.processPluginConfigurationUpdateResult(result); })
            .catch(function (err) {
              console.error('PosterRotator save error:', err);
              alert('Failed to save configuration. See console for details.');
            })
            .finally(function () { Dashboard.hideLoadingMsg(); });

          return false;
        }

        var root = byId('PosterRotatorConfigPage');
        var form = byId('PosterRotatorConfigForm');

        if (root) {
          root.addEventListener('pageshow', load);
          root.addEventListener('viewshow', load); // covers new-tab case
        }
        if (form) {
          form.addEventListener('submit', save);
        }
      })();
    </script>
  </div>
</body>
</html>
